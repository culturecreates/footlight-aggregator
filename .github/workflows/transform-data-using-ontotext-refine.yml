name: Transform data using Onto Refine and upload to Artsdtaa

on:
  workflow_dispatch:

jobs:
  transform-data-using-ontorefine:
    runs-on: ubuntu-latest
    container:
      image: ontotext/refine:1.2.1
      options: --user root
      ports:
        - 7333:7333
    steps:
      - name: Run ontorefine
        run: /opt/ontorefine/dist/bin/ontorefine &

      - name: Install curl
        run: apk update && apk add curl

      - name: Download open-api response
        run: |
          curl 'https://api.footlight.io/calendars/tout-culture/events?page=1&limit=10' >> events.json

      - name: Download project-configuration-file
        run: |
          curl 'https://raw.githubusercontent.com/culturecreates/footlight-aggregator/main/data/ontorefine/open-api-transform-project-configuration.json' >> project-config.json

      - name: Debug - pwd
        run: pwd

      - name: debug - ls
        run: ls ../

      - name: Transform json data to RDF
        run: /opt/ontorefine/dist/bin/ontorefine-cli transform events.json -u http://localhost:7333 --configurations project-config.json -f json >> events.ttl

      - name: Upload RDf file to S3
        uses: prewk/s3-cp-action@v2
        with:
          aws_access_key_id: ${{ secrets.S3_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          source: 'events.ttl'
          dest: 's3://footlight-aggregator-pipeline-files'

  upload-to-artsdata:
    needs: transform-data-using-ontorefine
    runs-on: ubuntu-latest
    steps:
      - name: Set current date as output
        id: version  # this is used on variable path
        run: echo "dumpdate=$(date +'%Y-%m-%dT%H-%M-%S')" >> $GITHUB_OUTPUT

      - name: Call Artsdata Databus
        run: |
          curl \
          -H 'Content-Type: application/json' \
          -X POST http://api.artsdata.ca/databus/  \
          --data '{ "artifact": "footlight-cms-events",
                    "comment": "Events from the Footlight CMS",
                    "publisher": "${{ secrets.PUBLISHER_URI_GREGORY }}",
                    "group": "${{ github.event.repository.name }}",
                    "version": "${{ steps.version.outputs.dumpdate }}",
                    "downloadUrl": "s3://footlight-aggregator-pipeline-files/events.ttl",
                    "downloadFile": "events.ttl",
                    "reportCallbackUrl": "https://webhook.site/be245341-5a1b-44cd-896f-590003162b07"
                  }' 
